<!DOCTYPE html>
<html>
<head>
    <title>Custom Integration Example</title>
    <style>
        #center {
            text-align: center;
            display: flex;
            flex-direction: column;
        }
    </style>
    <script>
        geotab.addin.integrationExample = function(api, state) {
            const fileName = 'Test6.jpeg'
            const solutionId = 'aTM3MzM1N2EtMjNlYi1hMWN';
            var host = 'my135.geotab.com',
                credentials = {},
                fileId =  'akZ_h84l6SkmxZeJnpK8KQw' //''
            var mediaFile

            const getImgUrl = (id) => {
                return `https://${host}/apiv1/DownloadMediaFile?mediaFile={"id":"${id}"}&credentials={"userName":"${credentials.userName}","database":"${credentials.database}","sessionId":"${credentials.sessionId}"}`
            }

            const getDownloadUrl = (id) => {
                let userName = encodeURIComponent(credentials.userName);
                let database = encodeURIComponent(credentials.database);
                let sessionId = encodeURIComponent(credentials.sessionId);
                return `https://${host}/apiv1/DownloadMediaFile?mediaFile={"id":"${id}"}&credentials={"userName":"${userName}","database":"${database}","sessionId":"${sessionId}"}`;
            }

            const uploadFile = () => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    var parameters = {
                        method: 'UploadMediaFile',
                        params: {
                            credentials: {
                                userName: credentials.userName,
                                database: credentials.database,
                                sessionId: credentials.sessionId
                            },
                            mediaFile: { 'id': fileId }
                        }
                    };
                    let xhr = new XMLHttpRequest();
                    if (true) {
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        fd.append(fileName, mediaFile, fileName);
                        
                        xhr.addEventListener('load', function (e) {
                            // e.preventDefault();
                            alert(`Загружено: ${xhr.status} ${xhr.response}`);
                            alert(JSON.stringify(e))
                            if (e.target && e.target['responseText'].length > 0) {
                                try {
                                    let jsonResponse = JSON.parse(e.target['responseText']);
                                    if (!jsonResponse.error) {
                                        document.getElementById('info').innerHTML = getImgUrl(fileId);
                                        document.getElementById('photo').setAttribute('src', getImgUrl(fileId));
                                        resolve(mediaFile);
                                    } else {
                                        reject(jsonResponse.error);
                                    }
                                } catch (e) {
                                    reject(e);
                                }
                            } else {
                                reject(e);
                                xhr && xhr.abort();
                            }
                        }, false);
                        xhr.addEventListener('error', function (e) {
                            if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                                reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                            } else {
                                reject(e);
                            }
                        }, false);
                        const url = `https://${host}/apiv1`;
                        // alert(url)
                        xhr.open('POST', url, true);

                        // xhr.setRequestHeader("Content-Type", "multipart/form-data");
                        // xhr.setRequestHeader("cache-control", "no-cache");
                        
                        xhr.send(fd)
                    }
                });
            }

            const downloadFile = (imgTagId = 'photo') => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    var parameters = {
                        method: 'DownloadMediaFile',
                        params: {
                            credentials: {
                                userName: credentials.userName,
                                database: credentials.database,
                                sessionId: credentials.sessionId
                            },
                            mediaFile: { 'id': fileId }
                        }
                    };
                    // let xhr = new XMLHttpRequest();

                    if (true) {
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        // xhr.addEventListener('load', function (e) {
                        //     alert(`Загружено: ${xhr.status} ${xhr.responseType}`);
                        //     alert(JSON.stringify(e))


                        //     arrayBuffer()

                        //     var uInt8Array = new Uint8Array(xhr.response);
                        //     var i = uInt8Array.length; alert('i', uInt8Array)
                        //     var binaryString = new Array(i);
                        //     while (i--){
                        //         binaryString[i] = String.fromCharCode(uInt8Array[i]);
                        //     }
                        //     var data = binaryString.join(''); alert(data)
                        //     var base64 = window.btoa(data);

                        //     document.getElementById(imgTagId).src="data:image/png;base64," + base64;
                        //     resolve()

                        //     if (e.target && e.target['responseText'].length > 0) {
                        //         try {
                        //             let jsonResponse = JSON.parse(e.target['responseText']);
                        //             if (!jsonResponse.error) {
                        //                 document.getElementById(imgTagId).setAttribute('src', xhr.response);
                        //                 resolve();
                        //             } else {
                        //                 reject(jsonResponse.error);
                        //             }
                        //         } catch (e) {
                        //             reject(e);
                        //         }
                        //     } else {
                        //         reject(e);
                        //         xhr && xhr.abort();
                        //     }
                        // }, false);
                        // xhr.addEventListener('error', function (e) {
                        //     if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                        //         reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                        //     } else {
                        //         reject(e);
                        //     }
                        // }, false);
                        const url = `https://${host}/apiv1`;
                        // alert(url)
                        
                        // xhr.open('POST', url, true);
                        // xhr.send(fd)

                        fetch(url, {method: 'POST', body: fd}).then( resp => {
                            alert(resp)
                            resp.arrayBuffer().then(r => {
                                alert(r)
                                const bytes = new Uint8Array(buffer);
                                alert(bytes)
                                const blob = new Blob([bytes.buffer]);
                                alert(blob)

                                const reader = new FileReader();

                                reader.addEventListener('load', (e) => {
                                    document.getElementById(imgTagId).src = e.target.result;
                                });

                                reader.readAsDataURL(blob);
                            });
                        })
                    }
                });
            }


            const upload = () => {
                return new Promise((resolve, reject) => {
                    // if (!mediaFile) {
                    //     throw new Error('Missing file');
                    // }

                    api.call('Add', {
                        typeName: 'MediaFile',
                        entity: {
                            name: fileName,
                            fromDate: new Date(),
                            solutionId: solutionId,
                            // file: mediaFile
                        }
                    }, result => {
                        alert('ok = ' + JSON.stringify(result))
                        fileId = result;
                        resolve();
                    }, reject => {
                        alert('err = ' + JSON.stringify(reject))
                    })
                }).then(uploadFile)
            }

                    
            const clearOnLeaving = () => {
                document.getElementById('photoBtn').removeEventListener("click");
            };
            const takePhoto = () => {
                // uploadFile();
                if (api.mobile.exists()){
                    api.mobile.camera.takePicture().then((media) => {
                        document.getElementById('photo').setAttribute('src', media);
                        // mediaFile = new File([new Blob([media])], fileName, {type:"image/jpeg"});

                        fetch(media).then(res => res.blob())
                            .then(blob => {
                                mediaFile = new File([blob], fileName, { type: "image/jpeg" });
                                alert(mediaFile)
                                uploadFile()
                            });
                        
                        // upload().then(uploadFile)
                    });
                }
            };
            const refreshPage = () => {
                document.getElementById('photoBtn').addEventListener('click', () => {
                    takePhoto();
                });
            }

            return {
                initialize: function(api, state, callback) {
                    api.getSession(cr => {
                        const getUrl = s => {
                            if (s.startsWith('http')) {
                                return new URL(s).hostname;
                            }
                            return s;
                        };
                        host = cr.server ? getUrl(cr.server) : document.location.hostname;
                        credentials = cr.credentials || cr;

                        // document.getElementById('info').innerHTML = `host = ${host}` + JSON.stringify(credentials)
                        // document.getElementById('photo').setAttribute('data-src', 'https://my135.geotab.com/apiv1/DownloadMediaFile?mediaFile={"id":"akZ_h84l6SkmxZeJnpK8KQw"}&credentials={"userName":"andrew.tolstov%40gmail.com","database":"gogps","sessionId":"0IoNjd7Q2_lUKZeUDd7csA"}')
                        downloadFile()
                    });
                    api.call('Get', {
                            typeName: 'MediaFile',
                            resultsLimit: 100
                        },
                       rezult => {
                           rezult.forEach(element => {
                               if (element.status === 'Ready'){
                                    const cloneNode = document.querySelector('.info__parent').cloneNode(true);
                                    document.querySelector('.info').appendChild(cloneNode);
                                    // cloneNode.querySelector('img').setAttribute('src', getDownloadUrl(element.id));
                                    cloneNode.querySelector('p').innerHTML = element.name;
                               }
                           });
                       } 
                    );
                    callback();
                },
                focus: function(api, state) {
                    refreshPage();
                },
                blur: function(api, state) {
                    clearOnLeaving();
                }
            }
        };
    </script>
</head>
<body>
    <div id="center">
        <button id="photoBtn">Take a photo</button>
        <img src="" id="photo" alt="photo">
        <pre id="info"></pre>
        <p>List of images</p>
        <div class="info">
            <div class="info__parent">
                <p></p>
                <img src="" alt="" width="200px" height="200px">
            </div>
        </div>
    </div>
</body>
</html>