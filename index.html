<!DOCTYPE html>
<html>
<head>
    <title>Custom Integration Example</title>
    <style>
        #center {
            text-align: center;
            display: flex;
            flex-direction: column;
        }
    </style>
    <script>
        geotab.addin.integrationExample = function(api, state) {
            const fileId = 'ajg1MDg0M2UtYWZiYi05Y2Z',
                  fileName = 'Test Media File'
            var host = 'my135.geotab.com',
                credentials = {}

            const uploadFile = (mediaFile) => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    const file = mediaFile;
                    var parameters = {
                        method: 'UploadMediaFile',
                        params: {
                            credentials: credentials,
                            mediaFile: { 'id': fileId }
                        }
                    };
                    let xhr = new XMLHttpRequest();
                    document.getElementById('info').innerHTML = 'pre file';
                    document.getElementById('photo').setAttribute('src', file);
                    if (true) {
                        document.getElementById('info').innerHTML = 'file';
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        fd.append(fileName, file, fileName);

                        xhr.addEventListener('load', function (e) {
                            e.preventDefault();
                            document.getElementById('info').innerHTML = 'load';
                            if (e.target && e.target['responseText'].length > 0) {
                                try {
                                    let jsonResponse = JSON.parse(e.target['responseText']);
                                    if (!jsonResponse.error) {
                                        resolve(mediaFile);
                                    } else {
                                        reject(jsonResponse.error);
                                    }
                                } catch (e) {
                                    reject(e);
                                }
                            } else {
                                reject(e);
                                xhr && xhr.abort();
                            }
                        }, false);
                        xhr.addEventListener('error', function (e) {
                            if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                                reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                            } else {
                                reject(e);
                            }
                        }, false);
                        xhr.open('POST', `https://${host}/apiv1/`);
                        xhr.setRequestHeader('Accept', 'application/json, */*;q=0.8');
                        document.getElementById('info').innerHTML = 'open'
                        try {
                            xhr.send(fd);
                            document.getElementById('info').innerHTML = 'send';
                            document.getElementById('photo').setAttribute('src', mediaFile);
                        } catch (e) {
                            reject(e);
                        }
                    }
                });
            }

            const clearOnLeaving = () => {
                document.getElementById('photoBtn').removeEventListener("click");
            };
            const takePhoto = () => {
                if (api.mobile.exists()){
                    api.mobile.camera.takePicture().then((media) => {
                        uploadFile(media);
                    });
                }
            };
            const refreshPage = () => {
                document.getElementById('photoBtn').addEventListener('click', () => {
                    takePhoto();
                });
            }

            return {
                initialize: function(api, state, callback) {
                    api.getSession(cr => {
                        const getUrl = s => {
                            if (s.startsWith('http')) {
                                return new URL(s).hostname;
                            }
                            return s;
                        };
                        host = cr.server ? getUrl(cr.server) : document.location.hostname;
                        credentials = cr.credentials || cr;

                        document.getElementById('info').innerHTML = `host = ${host}` + JSON.stringify(credentials)
                    });
                    callback();
                },
                focus: function(api, state) {
                    refreshPage();
                },
                blur: function(api, state) {
                    clearOnLeaving();
                }
            }
        };
    </script>
</head>
<body>
    <div id="center">
        <button id="photoBtn">Take a photo</button>
        <img src="" id="photo" alt="photo">
        <pre id="info"></pre>
    </div>
</body>
</html>