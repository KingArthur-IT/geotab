<!DOCTYPE html>
<html>
<head>
    <title>Custom Integration Example</title>
    <style>
        #center {
            text-align: center;
            display: flex;
            flex-direction: column;
        }
    </style>
    <script>
        geotab.addin.integrationExample = function(api, state) {
            const fileName = 'Test6.jpeg'
            const solutionId = 'aTM3MzM1N2EtMjNlYi1hMWN';
            const imgId = 'akZ_h84l6SkmxZeJnpK8KQw'
            var host = 'my135.geotab.com',
                credentials = {},
                fileId = ''
            var mediaFile

            const resizeImage = () => {
                return new Promise((resolve, reject) => {
                    const width = 480;
                    const contentType = 'jpeg';
                    const elem = document.createElement('canvas');

                    const scaleFactor = width / document.getElementById('photo').clientWidth;
                    elem.width = width;
                    elem.height = document.getElementById('photo').clientHeight * scaleFactor;

                    const ctx = elem.getContext('2d');
                    ctx.drawImage(document.getElementById('photo'), 0, 0, width, elem.height);
                    ctx.canvas.toBlob((blob) => {
                        mediaFile = new File([blob], fileName, {
                            type: contentType,
                            lastModified: Date.now()
                        });

                        resolve();
                    }, contentType, 1);
                });

            }

            const uploadFile = () => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    const file = mediaFile;
                    var parameters = {
                        method: 'UploadMediaFile',
                        params: {
                            credentials: credentials,
                            mediaFile: {
                                typeName: 'MediaFile',
                                type: 'MediaFile',
                                id: imgId,
                                file: document.getElementById('photo').getAttribute('src'),
                                name: fileName,
                                fromDate: new Date(),
                                solutionId: solutionId,
                            },
                            stream: document.getElementById('photo').getAttribute('src')
                        }
                    };
                    let xhr = new XMLHttpRequest();
                    if (true) {
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        fd.append(fileName, document.getElementById('photo').getAttribute('src'));

                        alert(fd)
                        
                        xhr.addEventListener('load', function (e) {
                            e.preventDefault();
                            alert(JSON.stringify(e))
                            if (e.target && e.target['responseText'].length > 0) {
                                try {
                                    let jsonResponse = JSON.parse(e.target['responseText']);
                                    if (!jsonResponse.error) {
                                        document.getElementById('info').innerHTML = 'resolve';
                                        document.getElementById('photo').setAttribute('src', `https://${host}/apiv1/DownloadMediaFile?mediaFile={"id":"${fileId}"}&credentials={"userName":"${credentials.userName}","database":"${credentials.database}","sessionId":"${credentials.sessionId}"}`);
                                        resolve(mediaFile);
                                    } else {
                                        reject(jsonResponse.error);
                                    }
                                } catch (e) {
                                    reject(e);
                                }
                            } else {
                                reject(e);
                                xhr && xhr.abort();
                            }
                        }, false);
                        xhr.addEventListener('error', function (e) {
                            if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                                reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                            } else {
                                reject(e);
                            }
                        }, false);
                        xhr.open('POST', `https://${host}/apiv1/UploadMediaFile`);
                        xhr.setRequestHeader('Accept', 'multipart/form-data, */*;q=0.8');
                        try {
                            xhr.send(fd);
                        } catch (e) {
                            reject(e);
                        }
                    }
                });
            }

            // const uploadFile = () => {
            //     // alert(JSON.stringify(document.getElementById('photo').getAttribute('src')))
            //     api.call('UploadMediaFile', {
            //         credentials: credentials,
            //         mediaFile: {
            //             typeName: 'MediaFile',
            //             type: 'MediaFile',
            //             id: imgId,
            //             file: new Blob([document.getElementById('photo').getAttribute('src')]),
            //             name: fileName,
            //             fromDate: new Date(),
            //             solutionId: solutionId,
            //         },
            //         stream: new Blob([document.getElementById('photo').getAttribute('src')])
            //     }, result => {
            //         alert('ok = ' + JSON.stringify(result))
            //         fileId = result;
            //     }, reject => {
            //         alert('err = ' + JSON.stringify(reject))
            //     })
            // }


            const upload = (mediaFile) => {
                return new Promise((resolve, reject) => {
                    // if (!mediaFile) {
                    //     throw new Error('Missing file');
                    // }

                    api.call('Add', {
                        typeName: 'MediaFile',
                        entity: {
                            name: fileName,
                            fromDate: new Date(),
                            solutionId: solutionId,
                            // file: mediaFile
                        }
                    }, result => {
                        alert('ok = ' + JSON.stringify(result))
                        fileId = result;
                        resolve(mediaFile);
                    }, reject => {
                        alert('err = ' + JSON.stringify(reject))
                    })
                })
                    .then(uploadFile)
            }

                    
            const clearOnLeaving = () => {
                document.getElementById('photoBtn').removeEventListener("click");
            };
            const takePhoto = () => {
                if (api.mobile.exists()){
                    api.mobile.camera.takePicture().then((media) => {
                        // const file = new Blob([media], {type:"application/octet-stream"});

                        // const mediaFile = new File([file], fileName);

                        // upload(media);
                        document.getElementById('photo').setAttribute('src', media);
                        // mediaFile = media
                        resizeImage().then(uploadFile)
                        // uploadFile(mediaFile)
                    });
                }
            };
            const refreshPage = () => {
                document.getElementById('photoBtn').addEventListener('click', () => {
                    takePhoto();
                });
            }

            return {
                initialize: function(api, state, callback) {
                    api.getSession(cr => {
                        const getUrl = s => {
                            if (s.startsWith('http')) {
                                return new URL(s).hostname;
                            }
                            return s;
                        };
                        host = cr.server ? getUrl(cr.server) : document.location.hostname;
                        credentials = cr.credentials || cr;

                        document.getElementById('info').innerHTML = `host = ${host}` + JSON.stringify(credentials)
                    });
                    api.call('Get', {
                            typeName: 'MediaFile',
                            resultsLimit: 100
                        },
                       rezult => {
                        //    document.getElementById('info').innerHTML = JSON.stringify(rezult);
                            document.getElementById('photo').setAttribute('src', `https://${host}/apiv1/DownloadMediaFile?mediaFile={"id":"${rezult[rezult.length - 1].id}"}&credentials={"userName":"${credentials.userName}","database":"${credentials.database}","sessionId":"${credentials.sessionId}"}`)
                       } 
                    )
                    callback();
                },
                focus: function(api, state) {
                    refreshPage();
                },
                blur: function(api, state) {
                    clearOnLeaving();
                }
            }
        };
    </script>
</head>
<body>
    <div id="center">
        <button id="photoBtn">Take a photo</button>
        <img src="" id="photo" alt="photo">
        <pre id="info"></pre>
    </div>
</body>
</html>