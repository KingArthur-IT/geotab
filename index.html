<!DOCTYPE html>
<html>
<head>
    <title>Custom Integration Example</title>
    <style>
        #center {
            text-align: center;
            display: flex;
            flex-direction: column;
        }
    </style>
    <script>
        geotab.addin.integrationExample = function(api, state) {
            const fileName = ''
            const solutionId = 'aTM3MzM1N2EtMjNlYi1hMWN';
            var host = 'my135.geotab.com',
                credentials = {},
                fileId =  '' //''akZ_h84l6SkmxZeJnpK8KQw
            var mediaFile

            // const getImgUrl = (id) => {
            //     return `https://${host}/apiv1/DownloadMediaFile?mediaFile={"id":"${id}"}&credentials={"userName":"${credentials.userName}","database":"${credentials.database}","sessionId":"${credentials.sessionId}"}`
            // }

            const makeFileName = (length) => {
                var result           = '';
                var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                var charactersLength = characters.length;
                for ( var i = 0; i < length; i++ ) {
                    result += characters.charAt(Math.floor(Math.random() * charactersLength));
                }
                return result;
            }

            const uploadFile = () => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    var parameters = {
                        method: 'UploadMediaFile',
                        params: {
                            credentials: {
                                userName: credentials.userName,
                                database: credentials.database,
                                sessionId: credentials.sessionId
                            },
                            mediaFile: { 'id': fileId }
                        }
                    };
                    let xhr = new XMLHttpRequest();
                    if (true) {
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        fd.append(fileName, mediaFile, fileName);
                        
                        xhr.addEventListener('load', function (e) {
                            // e.preventDefault();
                            alert(`Загружено: ${xhr.status} ${xhr.response}`);
                            alert(JSON.stringify(e))
                            if (e.target && e.target['responseText'].length > 0) {
                                try {
                                    let jsonResponse = JSON.parse(e.target['responseText']);
                                    if (!jsonResponse.error) {
                                        downloadFile(fileId).then(image => document.getElementById('photo').src = image);
                                        document.getElementById('info').innerHTML = 'Image saved succesfully';
                                        resolve();
                                    } else {
                                        reject(jsonResponse.error);
                                    }
                                } catch (e) {
                                    reject(e);
                                }
                            } else {
                                reject(e);
                                xhr && xhr.abort();
                            }
                        }, false);
                        xhr.addEventListener('error', function (e) {
                            if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                                reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                            } else {
                                reject(e);
                            }
                        }, false);
                        const url = `https://${host}/apiv1`;
                        xhr.open('POST', url, true);

                        // xhr.setRequestHeader("Content-Type", "multipart/form-data");
                        // xhr.setRequestHeader("cache-control", "no-cache");
                        
                        xhr.send(fd)
                    }
                });
            }

            const downloadFile = (id) => {
                return new Promise((resolve, reject) => {
                    var fd = new FormData();
                    var parameters = {
                        method: 'DownloadMediaFile',
                        params: {
                            credentials: {
                                userName: credentials.userName,
                                database: credentials.database,
                                sessionId: credentials.sessionId
                            },
                            mediaFile: { 'id': id }
                        }
                    };
                    let xhr = new XMLHttpRequest();

                    if (true) {
                        fd.append('JSON-RPC', encodeURIComponent(JSON.stringify(parameters)));
                        xhr.addEventListener('load', function (e) {
                            // alert(`Загружено: ${xhr.status}`);

                            const reader = new FileReader();
                            reader.readAsDataURL(xhr.response);
                            reader.onloadend = () => resolve(reader.result);

                        }, false);
                        xhr.addEventListener('error', function (e) {
                            if (e.target || (e instanceof XMLHttpRequest && e.status === 0)) {
                                reject('Network Error: Couldn\'t connect to the server. Please check your network connection and try again.');
                            } else {
                                reject(e);
                            }
                        }, false);
                        const url = `https://${host}/apiv1`;
                        
                        xhr.open('POST', url, true);
                        xhr.responseType = 'blob';
                        xhr.send(fd)
                    }
                });
            }

            const upload = () => {
                return new Promise((resolve, reject) => {
                    // if (!mediaFile) {
                    //     throw new Error('Missing file');
                    // }

                    api.call('Add', {
                        typeName: 'MediaFile',
                        entity: {
                            name: fileName,
                            fromDate: new Date(),
                            solutionId: solutionId,
                        }
                    }, result => {
                        alert('ok = ' + JSON.stringify(result))
                        fileId = result;
                        resolve();
                    }, reject => {
                        alert('err = ' + JSON.stringify(reject))
                    })
                })
            }
                   
            const clearOnLeaving = () => {
                document.getElementById('photoBtn').removeEventListener("click");
            };
            
            const takePhoto = () => {
                if (api.mobile.exists()){
                    api.mobile.camera.takePicture().then((media) => {
                        fetch(media).then(res => res.blob())
                            .then(blob => {
                                fileName = makeFileName(8) + '.jpeg';
                                mediaFile = new File([blob], fileName, { type: "image/jpeg" });
                                // alert(mediaFile)
                                upload().then(uploadFile)
                            });
                    });
                }
            };
            
            const refreshPage = () => {
                document.getElementById('photoBtn').addEventListener('click', () => {
                    takePhoto();
                });
            }

            return {
                initialize: function(api, state, callback) {
                    api.getSession(cr => {
                        const getUrl = s => {
                            if (s.startsWith('http')) {
                                return new URL(s).hostname;
                            }
                            return s;
                        };
                        host = cr.server ? getUrl(cr.server) : document.location.hostname;
                        credentials = cr.credentials || cr;
                    });
                    api.call('Get', {
                            typeName: 'MediaFile',
                            resultsLimit: 100
                        },
                       rezult => {
                        //    document.getElementById('list').innerHTML = 'Loading ...';
                           rezult.forEach((element, inx) => {
                               if (element.status === 'Ready'){
                                    const cloneNode = document.querySelector('.info__parent').cloneNode(true);
                                    document.querySelector('.info').appendChild(cloneNode);
                                    cloneNode.querySelector('p').innerHTML = `${inx}. ` + element.name;
                                    downloadFile(element.id).then(image => cloneNode.querySelector('img').src = image)
                               }
                           });
                           document.querySelector('.info__parent').style.display = 'none';
                        //    document.getElementById('list').innerHTML = 'List of images:';
                       } 
                    );
                    callback();
                },
                focus: function(api, state) {
                    refreshPage();
                },
                blur: function(api, state) {
                    clearOnLeaving();
                }
            }
        };
    </script>
</head>
<body>
    <div id="center">
        <button id="photoBtn">Take a photo</button>
        <p id="info"></p>
        <img src="" id="photo" alt="photo">
        <p id="list">List of images:</p>
        <div class="info">
            <div class="info__parent">
                <p></p>
                <img src="" alt="" width="100px" height="100px">
            </div>
        </div>
    </div>
</body>
</html>